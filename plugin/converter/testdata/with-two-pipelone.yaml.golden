kind: pipeline
name: test-service-name

trigger:
  event:
    exclude:
      - promote

volumes:
  - name: docker
    host:
      path: /var/run/docker.sock

anchors:
  - &mvn-step
    image: openjdk-11
    privileged: true
    volumes:
      - name: m2-cache
        path: /root/.m2
      - name: docker
        path: /var/run/docker.sock
    environment:
      SONAR_PROJECT_NAME: test-service-name
      GIT_PUSH_SSH_KEY:
        from_secret: git_ssh_key

steps:
  - name: build-and-test
    <<: *mvn-step
    commands:
      - mvn package -U -B
    when:
      branch:
        exclude:
          - master
---

kind: pipeline
name: test-service-name-um

trigger:
  event:
    - promote
  target:
    - um-prod
    - um-dev

volumes:
  - name: docker
    host:
      path: /var/run/docker.sock

anchors:
  - &mvn-step
    image: openjdk-11
    privileged: true
    volumes:
      - name: m2-cache
        path: /root/.m2
      - name: docker
        path: /var/run/docker.sock
    environment:
      SONAR_PROJECT_NAME: test-service-name
      GIT_PUSH_SSH_KEY:
        from_secret: git_ssh_key

steps:
  - name: build-and-test
    <<: *mvn-step
    commands:
      - mvn package -U -B